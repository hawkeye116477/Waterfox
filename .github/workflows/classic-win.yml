name: Build Classic for Windows

on:
  pull_request:
    branches:
      - classic
  workflow_dispatch: null

env:
  ENABLE_ARTIFACTS_MODE: "true"
  MOZCONFIG: "./.mozconfig-ga"
  SHELL: "/bin/bash"

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v2
      - name: Test
        shell: bash
        run: |
          ls -l "/c/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/VC/Redist/MSVC/14.16.27012/x64"
      - name: Set build directory and system path
        run: |
          $pattern = '[\\]'
          $BUILD_DIR = $env:GITHUB_WORKSPACE -replace $pattern, '/'
          echo "${BUILD_DIR}"
          echo "G_WORKSPACE=${BUILD_DIR}" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "C:\ProgramData\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Install depends
        run: |
          iwr -useb get.scoop.sh | iex
          scoop install sccache llvm nasm --global
          sccache --version
          nasm --version
          clang-cl --version
          mkdir -p ~\\scoop\\buckets\\my-bucket
          Copy-Item -Path $env:GITHUB_WORKSPACE\\build\\github-actions\\mozilla-build.json -Destination ~\scoop\buckets\my-bucket
          scoop install my-bucket/mozilla-build --global
      - name: Cache for Linux
        uses: actions/cache@v2
        with:
            path: |
                ~/AppData/Local/Mozilla/sccache/cache
            key: ${{ runner.os }}-${{ hashFiles('**/browser/config/version_display.txt') }}
      - name: Build
        run: |
          C:\\ProgramData\\scoop\\apps\\mozilla-build\\current\\start-shell.bat "$Env:G_WORKSPACE/build/github-actions/build.sh"
      - name: Package
        run: |
          C:\\ProgramData\\scoop\\apps\\mozilla-build\\current\\start-shell.bat "$Env:G_WORKSPACE/build/github-actions/package.sh"
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
         name: Artifact_Classic_Windows_${{ github.run_id }}
         path: ./objdir-*/dist/*.zip
